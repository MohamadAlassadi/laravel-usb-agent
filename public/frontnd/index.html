<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>USB Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h1>USB Manager</h1>

    <!-- Login Form -->
    <div id="login-section">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <p id="login-message" class="message"></p>
    </div>

    <!-- Main USB Section -->
    <div id="usb-section" style="display:none;">
        <button onclick="logout()" class="logout-btn">Logout</button>
        <h2>USB Files</h2>
        <ul id="file-list"></ul>

        <h3>Upload File</h3>
        <input type="file" id="file-input">
        <button onclick="uploadFile()">Upload</button>
        <p id="upload-message" class="message"></p>
    </div>
</div>

<script>
let accessToken = '';

async function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, password})
    });
    const data = await res.json();

    if(data.success) {
        accessToken = data.access_token;
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('usb-section').style.display = 'block';
        listFiles();
    } else {
        document.getElementById('login-message').textContent = data.message;
    }
}

async function logout() {
    await fetch('/api/logout', {
        method: 'POST',
        headers: {'Authorization': 'Bearer ' + accessToken}
    });
    accessToken = '';
    document.getElementById('usb-section').style.display = 'none';
    document.getElementById('login-section').style.display = 'block';
}

async function listFiles() {
    const res = await fetch('/api/usb/files', {
        headers: {'Authorization': 'Bearer ' + accessToken}
    });
    const data = await res.json();
    const list = document.getElementById('file-list');
    list.innerHTML = '';
    if(data.files){
        data.files.forEach(file => {
            const li = document.createElement('li');
            li.innerHTML = `${file} <button onclick="downloadFile('${file}')">Download</button>`;
            list.appendChild(li);
        });
    }
}

async function uploadFile() {
    const input = document.getElementById('file-input');
    if(!input.files.length) return;
    const file = input.files[0];
    const formData = new FormData();
    formData.append('file', file);

    const res = await fetch('/api/usb/upload', {
        method: 'POST',
        headers: {'Authorization': 'Bearer ' + accessToken},
        body: formData
    });
    const data = await res.json();
    document.getElementById('upload-message').textContent = data.message || '';
    listFiles();
}

function downloadFile(filename) {
    const link = document.createElement('a');
    link.href = `/api/usb/download/${filename}?token=${accessToken}`;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>

</body>
</html>
